/*
IqTest: A javascript testing framework that promises to be easy

(c) 2012 James Treworgy
MIT License
*/

(function(a){a(["./iqtest"],function(z,B,C,r,f,A){var t,s,v,y,b,l={setup:null,teardown:null,timeout:10},n={name:"test-group",desc:"Unnamed Test Group",debug:false,timeout:null,setup:null,teardown:null},w={name:"test",desc:"Unnamed Test",func:null,timeout:null,debug:false},g="same,equals,typeOf,defined,isNull,match,isObject,isFunction,exception,tagName,className,isTrue,isFalse",q=false,c={};
function d(E,D){var u=c[E.split(".")[1]].args;return u<D.length?String(D[u]):"an anonymous test";
}function h(F,D){var E=0,G=/^.*?Expected.*?([0-9]) argument[s]?\s*$/;try{D();}catch(u){E=G.test(u.message)?parseInt(RegExp.$1,10):0;
}c[F]={args:E};}function p(){var u,D;if(q){return;}r.push({truthy:function(F,E){z.expectOpts(arguments,1);
return{passed:!!F,err:z.formatAssert(E,"The object {0} is {not}truthy",String(F))};
},resolves:function(F,E){z.expectOpts(arguments,1);return{passed:typeof F!=="undefined",err:z.formatAssert(E,"The object {0} did {not}resolve",String(F))};
}});D=v.prototype;u=buster.assertions;z.each(["assert","refute"],function(F,G){var E={};
z.each(g.split(","),function(H,I){h(I,u[G][I]);E[I]=function(){var J=((this.test&&this.test instanceof v)?this.test:this);
return J.queueTest(u[G][I],G+"."+I,z.toArray(arguments));};});z.each(r,function(H,I){z.each(I,function(K,J){if(!E[K]){h(K,J);
E[K]=function(){var L=((this.test&&this.test instanceof v)?this.test:this);return L.queueBooleanTest(J,G+"."+K,z.toArray(arguments),G==="refute");
};}});});if(G==="assert"){z.extend(D,E);}z.each(["backpromise","callback","then"],function(H,I){E[I]=function(){return this.test[I].apply(this.test,z.toArray(arguments));
};});D[G]=function(I,H){return D[G].truthy.apply(this,z.toArray(arguments));};z.extend(D[G],E);
q=true;});}z.extend(z,{event:function(u,E,D){if(z.isFunction(u)){u.call(E,D);}},expectOpts:function(u,D){if((u?u.length:0)<D){throw ({name:"AssertionError",type:"iq",message:z.format("Expected to receive at least {0} argument",D.toString())});
}},formatAssert:function(u,E,D){return !E?"":(u?u+": ":"")+z.format(E,z.isArray(D)?D:z.toArray(arguments,2));
}});function j(D,u){if(D[u]){D[u].apply(this,z.toArray(arguments,2));}}function e(D,E){var u=z.toArray(arguments,2);
return function(){var F=z.toArray(arguments).concat(u);if(F.length>0){E.apply(D,F);
}else{E.call(D);}};}function i(D,u){function E(){return D.apply(this,u);}E.prototype=D.prototype;
return new E();}function m(H){var F,E,D,I,G=this;function u(J){G.tests.push(J);J.group=G;
J.id=G.tests.length;}if(H.constructor===y){z.each(H.tests,function(K,J){u(J);});}else{if(H.constructor===v){u(H);
}else{if(typeof H==="string"){D=arguments[1];E=arguments[2];F=!!E;I={name:H,desc:F?D:"",func:F?E:D,debug:G.debug,timeout:G.timeout};
u(new v(I));}}}return G;}function x(u,E){var D;if(E.promise!==E._lastPromise){E._lastPromise=E.promise;
E._lastPromise.then(function(){x(u,E);},function(F){E.testerror(F,true);x(u,E);});
return;}if(!z.isBool(E.passed)){E.passed=(E.count===E.countPassed);}E._allPass&=E.passed;
E.doWriterEvent("testEnd",z.filterProps(E,"count,passed"));j.call(E,E,"teardown");
D=true;z.each(u.tests,function(G,F){if(!z.isBool(F.passed)){D=null;return false;}else{if(!F.passed){D=false;
}}});if(z.isBool(D)){u.passed=D;u.doWriterEvent("groupEnd");j.call(this,this,"teardown");
u.promise.resolve();}}function o(){var u=this;j.call(this,this,"setup");this.reset();
z.each(u.tests,function(D,E){E.reset();});this.doWriterEvent("groupStart",z.filterProps(u,"name,desc"));
z.each(u.tests,function(F,H){var D=z.extend({},H.assert,{test:H}),G=z.extend({},H.refute,{test:H});
j.call(H,H,"setup");H.doWriterEvent("testStart",z.filterProps(H,"name"));if(H.debug){H.func.call(H,D,G);
}else{try{H.func.call(H,D,G);}catch(E){H.testerror(z.format("An error occurred in your test code: {0}",E),true);
}}H._lastPromise=H.promise;H._allPass=true;H.promise.then(function(){x(u,H);},function(I){H.testerror(I,true);
x(u,H);});});return this;}function k(D,u){var E=this;z.each(this.group.writers,function(G,F){var H=F[D];
if(z.isFunction(H)){H.apply(F,[E].concat(u));}});}y=function(D,u,E){p();var F=D&&typeof D==="object"?D:u&&typeof u==="object"?u:E||{};
if(typeof u==="string"){F.name=D;}if(typeof u==="string"){F.desc=u;}z.extend(this,z.extend(null,n,F,true));
this.writers=[];this.doEvent=j;this.group=this;this.doWriterEvent=function(){k.apply(this,z.toArray(arguments));
};this.clear();};y.prototype={constructor:y,add:m,run:o,then:function(){return this.promise.then.apply(this,z.toArray(arguments));
},configure:function(D){if(typeof D==="string"){D={name:D};}var u=z.extend({},n);
z.extend(u,D,true);z.extend(this,u);return this;},reset:function(){this.promise=B.defer();
this.passed=null;return this;},clear:function(){this.tests=[];this.reset();return this;
},writer:function(u){var E,D=s.writers[u];if(!D){throw ("There is no output writer with id '{0}'".format(E));
}E=i(D,z.toArray(arguments,1));E.owner=this;this.writers.push(E);return this;},groupStart:z.donothing,groupEnd:z.donothing};
v=function(D){var u=this;z.extend(u,w);z.extend(u,D,true);u.id=null;u.group=null;
u.clear();this.doWriterEvent=function(){k.apply(this,z.toArray(arguments));};};v.prototype={constructor:v,impl:{},reset:function(){z.extend(this,{promise:B.defer(),results:[],count:0,countPassed:0,countFailed:0,nextThen:[],cbPromise:null,resolver:null,stopped:false,passed:null});
this.promise.resolve();},clear:function(){this.setDebug(false);},setDebug:function(u,D){this.debug=z.isBool(u)?u:true;
B.debug=this.debug;if(u){if(typeof D==="number"){this.debugCount=D;}}else{this.debugCount=-1;
}},nextIsProblemAssertion:function(){return this.debug&&!this.stopped&&this.debugCount>=0&&this.debugCount===this.count-1;
},timeoutOnce:function(E){var u=this,D=u.timeout;u.then(function(){u.timeout=E;});
u.afterNext(function(){u.timeout=D;});},configure:function(D){if(typeof D==="string"){D={name:D};
}var u=z.extend({},w);z.extend(u,this,D,true);z.extend(this,u);},then:function(u,E){var F=this,D=E||function(I){F.testerror(I,false);
},H=F.promise,G=B.defer();F.promise=G;H.then(function(J){try{if(F.nextIsProblemAssertion()){;
}u(J);}catch(I){F.testerror("An error occurred during a 'then' clause of an assertion: "+String(I),true);
}},D);B.chain(H,G);return F;},chain:function(u,D){var E=B.defer(),F=this.promise;
this.promise=E.promise;F.then(u,D||e(this,this.testerror));B.chain(F,E);return this;
},afterNext:function(u,D){this.nextThen.push({callback:u,errback:D});},startTest:function(u){this.count++;
this.assertionInfo=z.extend({},u,{count:this.count});this.doWriterEvent("itemStart",this.assertionInfo);
this.itemRunning=true;},endTest:function(D){var u=D;if(!this.itemRunning){this.testerror("Error: test was not running when endTest called: "+D.desc);
return;}if(!D.passed){u=this.addResult(D);this.countFailed++;}else{this.countPassed++;
}this.itemRunning=false;this.doWriterEvent("itemEnd",u);},queueBooleanTest:function(F,D,u,E){return this.queueTest(function(){var G=F.apply(null,z.toArray(arguments));
if(G.passed===E){throw ({name:"AssertionError",type:"iq",message:z.format(G.err.replace("{not}","{0}"),E?"not ":"")});
}},D,u);},queueTest:function(K,D,u){var I=this,F,E=D.split(".")[1],J=c[E].args,H,G,L,N,M=[];
if(I.stopped){return I;}if(I.cbPromise){H=true;G=G||B.defer();if(J===1){F=0;}else{if(u[0]&&!u[1]){F=1;
}else{if(u[1]&&!u[0]){F=0;}else{I.testerror(z.format("I couldn't figure out what to do with your magic callback. For this test you may need to define it explicitly.[{0}] {1}",D,d(u)));
return;}}}I.cbPromise.then(function(Q){u[F]=Q;},function(Q){G.reject("The callback failed. "+(Q?z.format("Reason: {0}",String(Q)):""));
});M.push(I.cbPromise);I.cbPromise=null;}if(E==="resolves"&&!B.isPromise(u[0])){throw ("The argument passed to 'resolves' was not a promise.");
}z.each(u,function(R,Q){if(B.isPromise(Q)){G=G||B.defer();if(R===0&&H){G.reject("You're using magic callback but you've also defined a promise as the first argument of your assert.");
}Q.then(function(S){u[R]=S;});M.push(Q);}});this.chain(function(){I.startTest({desc:d(D,u),assertion:D});
});if(M.length){M.push(I.promise);I.promise=I.timeout?C(G.promise,I.timeout*1000):G.promise;
B.chain(B.all(M),G);}L=B.defer();N=I.promise;I.promise=L.promise;N.then(function P(Q){if(I.runTest.call(I,K,D,u)){L.resolve();
}else{L.reject("The test failed");}},function O(Q){if(I.itemRunning){I.endTest({passed:false,err:String(Q)});
}L.reject("The test was stopped because an assertion failed.");});return I;},runTest:function(F,D,u){var G={assertion:D,err:"",passed:true};
try{F.apply(null,u);}catch(E){if(E.name!=="AssertionError"){if(this.debug){;F.apply(null,u);
}else{this.setDebug();E.message=(E.message||E.type)+". Debugging has been enabled.";
}}if(E.type==="iq"){E.message=z.format("[{0}] {1}",D,E.message);}G.err=E.message;
G.passed=false;}this.endTest(G);return G.passed;},addResult:function(E){var u=z.extend({},E),D=u.passed?"passed":"failed";
u.count=this.count;u.fulltext=z.format("Test #{0} {1} {2} {3}{4}",this.count,this.assertionInfo.assertion,D,u.passed?"":": "+E.err,z.format(' in test "{0}"',this.assertionInfo.desc));
this.results.push(u);return u;},testerror:function(E,u){var F=this;try{if(F.stopped){return;
}F.stopped=true;F.passed=false;this.doWriterEvent("testLog",z.format("{0}. {1}",String(E),u?"Debugging is enabled if you start again.":""));
}catch(D){;}if(u){F.setDebug(true,F.count);}},callback:function(F,G){var D=this,E=G||D.timeout,u=B.defer();
D.cbPromise=E?C(u,E*1000):u;return function(){var I;if(!F){I=true;}else{if(D.debug){I=F.apply(this,z.toArray(arguments));
}else{try{I=F.apply(this,z.toArray(arguments));}catch(H){D.testerror("An error occurred in your callback(): "+String(H),true);
u.reject(I);return;}}}u.resolve(I);};},when:function(u,H){var E=this,G=H||E.timeout,F=B.defer(),D=E.promise;
E.promise=G?C(F,G*1000):F;D.then(function(){u.call(E,F.resolve);}).then(null,function(I){E.testerror("An error occured during a 'when' operand: "+String(I),true);
F.reject();});return E;},backpromise:function(G,u,J){var E=B.defer(),H=this,I=J||H.timeout,D=function(){var L;
if(u){if(H.debug){L=u.apply(this,z.toArray(arguments));}else{try{L=u.apply(this,z.toArray(arguments));
}catch(K){H.testerror("An error occurred in your backpromise() callback: "+K,true);
E.reject(L);return;}}}E.resolve(L);};if(H.debug){G.call(H,D);}else{try{G.call(H,D);
}catch(F){H.testerror("An error occurred in your backpromise() function: "+F,true);
E.reject();return;}}return I?C(E,I*1000):E;}};t=z.extend({},l);s={create:function(G,u,F){var D=z.extend({timeout:t.timeout,setup:t.setup,teardown:t.teardown},F);
var E=new y(G,u,D);return E;},add:function(){return this.add.apply(this,z.toArray(arguments));
},extend:function(u){r.push(u);},configure:function(u){z.extend(t,u,true);},options:t,writers:{},impl:{TestGroup:y,Test:v,Assert:b,utility:z}};
return s;});}(typeof define==="function"?define:function(a,b){if(typeof module!=="undefined"){module.exports=b(require("./when"),require("./timeout"),require("./buster-assertions"),require("./common.utils"));
}else{if(!this.iqtest_assertions){this.iqtest_assertions=[];}this.iqtest=b(this.common.utils,this.when,this.when_timeout,this.iqtest_assertions,this.buster?this.buster.assert:null);
}}));