/*
IqTest: A javascript testing framework that promises to be easy

(c) 2012 James Treworgy
MIT License
*/

var iqtest=(function(b){var j,f,e,g,i,c,d={name:"Unnamed Test Group",debug:false},h={name:"",desc:"Unnamed Test",func:null,timeoutSeconds:10};
j={extend:function(s){var p,q,r,k,n=arguments.length,l=typeof arguments[n-1]==="boolean",m=l?n-2:n-1,o=l?arguments[m+1]:false;
r=j.toArray(arguments,1,m+1);for(k=0;k<r.length;k++){q=r[k];for(p in q){if(q.hasOwnProperty(p)&&(!o||s.hasOwnProperty(p))){s[p]=q[p];
}}}return s;},toArray:function(k,l,m){return Array.prototype.slice.call(k,l||0,m);
},isArray:function(k){return k&&k.constructor==Array;},isFunction:function(k){return typeof k==="function";
},format:function(l){var k=(arguments.length===2&&this.isArray(arguments[1]))?arguments[1]:this.toArray(arguments,1);
return l.replace(/\{(\d+)\}/g,function(m,n){return typeof k[n]!=="undefined"?String(k[n]):m;
});},each:function(l,k){var m;if(this.isArray(l)){for(m=0;m<l.length;m++){if(k.call(l[m],m,l[m])===false){break;
}}}else{for(m in l){if(l.hasOwnProperty(m)){if(k.call(l[m],m,l[m])===false){break;
}}}}},event:function(k,m,l){if(j.isFunction(k)){k.call(m,l);}},donothing:function(){}};
f={pass:function(k){return{desc:k};},fail:function(l,k){return{actual:l||"[the test was aborted]",desc:k};
},resolves:function(l,k){return{actual:l,desc:k};},isTrue:function(k,l){return{actual:k,desc:l};
},areEqual:function(m,k,l){return{expected:m,actual:k,desc:l};}};j.extend(f,{isFalse:f.isTrue,isTruthy:f.isTrue,isFalsy:f.isTrue,areNotEqual:this.areEqual});
i=function(k){this.tests=[];j.extend(this,d);j.extend(this,k,true);this.promise=when.defer();
this.passed=null;};i.prototype={constructor:i,test:function(s,l,o){var t,k=true,q,n,r=this,p=!!o,u={name:s,desc:p?l:"",func:p?o:l};
t=new g(u);t.group=r;if(r.tests.length===0){j.event(r.groupStart,r,r);}r.tests.push(t);
t.id=r.tests.length;j.event(t.testStart,t,t);if(r.debug){t.func.call(t,t);}else{try{t.func.call(t,t);
}catch(m){j.event(r.log,r,j.format("An error occurred in your test code: {0}. Debugging is enabled if you start again.",m.toString()));
r.debug=true;r.passed=false;t.passed=false;}}q=t.promise;n=function(){if(t.promise!==q){q=t.promise;
q.then(n,n);return;}if(typeof t.passed!=="boolean"){t.passed=(t.count===t.countPassed);
}k&=t.passed;j.event(t.testEnd,t,t);if(t===r.tests[r.tests.length-1]){if(typeof r.passed!=="boolean"){r.passed=k;
}j.event(r.groupEnd,r,r);}};t.promise.then(n,n);return r;},then:function(m,k){if(j.isFunction(m)){this.promise=this.promise.then.apply(this.promise,j.toArray(arguments));
return this;}else{var l=new i(this);this.promise=this.promise.then(function(){l.test(m,k);
return l;},function(){alert("debug: failback called on a group");});return l;}},configure:function(l){var k=j.extend({},d);
j.extend(k,l,true);j.extend(this,k);return this;},groupStart:j.donothing,groupEnd:j.donothing};
g=function(l){var k=this;j.extend(k,h);j.extend(k,l,true);j.extend(k,{promise:when.defer(),results:[],count:0,countPassed:0,countFailed:0,group:null,nextThen:[],resolver:null});
this.id=null;k.promise.resolve();};function a(k,l,m){return{err:l===true?"":j.format('value "{0}" is not {1}',k.actual,m),desc:k.desc};
}g.prototype={constructor:g,impl:{pass:function(k){return{desc:k.desc};},fail:function(k){return{err:k.err,desc:k.desc};
},resolves:function(k){return{err:"",desc:k.desc};},isTrue:function(k){return a(k,k.actual===true,"true");
},isFalse:function(k){return a(k,k.actual===false,"false");},isTruthy:function(k){return a(k,!!k.actual,"truthy");
},isFalsy:function(k){return a(k,!!k.actual,"falsy");},areEqual:function(k){var l;
if(typeof k.actual!=typeof k.expected){l=j.format('test case type "{0}" !== expected type "{1}"',typeof k.actual,typeof k.expected);
}if(!l&&k.actual!=k.expected){l=j.format('value "{0}" !== expected value "{1}"',k.actual,k.expected);
}return{err:l,desc:k.desc};},areNotEqual:function(k){var l=this.areEqual(k.expected,k.actual,k.desc);
if(!l.err){l.err=j.format('Value "{0}" === expected value "{1}"',k.actual,k.expected);
}return l;}},timeout:function(m){var k=this,l=k.timeoutSeconds;k.then(function(){k.timeoutSeconds=m;
});k.afterNext(function(){k.timeoutSeconds=l;});},configure:function(l){var k=j.extend({},h);
j.extend(k,this,l,true);j.extend(this,k);},then:function(k,m){var o=this,n=function(p){o.testerror(p,false);
};function l(p,q){o.promise=o.promise.then(p,q||n);}l(k,m);if(o.afterNext.length>0){j.each(function(p,q){l(q.callback,q.errback);
});o.afterNext=[];}return o;},afterNext:function(k,l){this.nextThen.push({callback:k,errback:l});
},startTest:function(l){var k=j.extend({},l.assertArgs);this.count++;j.extend(k,{count:this.count});
j.event(this.itemStart,this,k);this.itemRunning=true;},endTest:function(m){var l=!m.err,k=j.extend(m,{passed:l});
if(!l){k=this.addResult(m);this.countFailed++;}else{this.countPassed++;}this.itemRunning=false;
j.event(this.itemEnd,this,k);},runTest:function(l,k){var m;m=this.impl[l].call(this,k);
m.assertFuncName=l;this.endTest(m);return m.passed;},addResult:function(m){var l=j.extend({},m),k=l.passed?"passed":"failed";
l.count=this.count;l.fulltext=j.format("Test #{0} [{1}] {2}{3}{4}",this.count,m.assertFuncName,k,l.passed?"":": "+m.err,m.desc?j.format(' in test "{0}"',m.desc):"");
this.results.push(l);return l;},runTestNow:function(n,l){var p=this,s,o,r,k=false,q=[],m=f[n].apply(p,l);
r=function(t){m.actual=t;};s=function(){if(p.runTest.call(p,n,m)){o.resolve();}else{o.reject("The test failed.");
}};k=when.isPromise(m.actual);if(p.cbPromise){if(k){o.reject("The actual value passed is a promise, but a callback has also been initiated");
}p.cbPromise.then(r,function(t){o.reject("The callback failed. "+t?j.format("Reason: {0}",t.toString()):"");
});q.push(p.cbPromise);p.cbPromise=null;}p.promise.then(function(){p.startTest({assertArgs:m,assertFuncName:n});
});if(k){m.actual.then(r);q.push(m.actual);}if(q.length){q.push(p.promise);p.promise=when.all(q);
}o=when.defer();p.then(s,function(t){o.reject(t);});p.promise=when_timeout(o.promise,p.timeoutSeconds*1000);
p.resolver=o.resolver;return p;},testerror:function(l,k){var m=this;if(m.resolver){m.resolver.reject(l);
m.resolver=null;}if(this.stopped){return;}this.stopped=true;j.event(m.group.log,m.group,j.format("{0}. {1}",l.toString(),k?"Debugging is enabled if you start again.":""));
m.group.debug=true;m.passed=false;},callback:function(m,n){var l=this,k=when.defer();
l.cbPromise=n?when_timeout(k,n*1000):k;return function(){var p;if(!m){p=true;}else{if(l.group.debug){p=m.apply(l,j.toArray(arguments));
}else{try{p=m.apply(l,j.toArray(arguments));}catch(o){l.testerror("An error occurred in your callback(): "+o,true);
k.reject(p);return;}}}k.resolve(p);};},backpromise:function(o,k,q){var m=when.defer(),p=this,l=function(){var s;
if(p.group.debug){s=k.apply(this,j.toArray(arguments));}else{try{s=k.apply(this,j.toArray(arguments));
}catch(r){p.testerror("An error occurred in your backpromise() callback: "+r,true);
m.reject(s);return;}}m.resolve(s);};if(p.group.debug){o.call(p,l);}else{try{o.call(p,l);
}catch(n){p.testerror("An error occurred in your backpromise() function: "+n,true);
m.reject();return;}}return q?when_timeout(m,q*1000):m;},testStart:j.donothing,testEnd:j.donothing,itemStart:j.donothing,itemEnd:j.donothing,log:j.donothing};
j.each(g.prototype.impl,function(l,k){g.prototype[l]=function(m){return this.runTestNow(l,j.toArray(arguments));
};});e={test:function(){var k=new i(this);return k.test.apply(k,j.toArray(arguments));
}};j.extend(b,e);e.impl={apiroot:b,TestGroup:i,Test:g,Assert:c,utility:j};return e;
}(window));